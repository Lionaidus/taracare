// server.js
import express from "express";
import cors from "cors";
import "dotenv/config";
import { GoogleGenerativeAI } from "@google/generative-ai";

const app = express();
app.use(cors());
app.use(express.json({ limit: "1mb" }));

app.get("/api/health", (_req, res) => res.json({ ok: true }));

// à¹ƒà¸Šà¹‰à¸„à¸µà¸¢à¹Œà¸ˆà¸²à¸ .env
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// à¹€à¸¥à¸·à¸­à¸à¹‚à¸¡à¹€à¸”à¸¥à¸ˆà¸²à¸ .env à¹„à¸”à¹‰ (à¸”à¸µà¸Ÿà¸­à¸¥à¸•à¹Œ 2.5-flash)
const model = genAI.getGenerativeModel({
  model: process.env.GEMINI_MODEL || "gemini-2.5-flash",
});

app.post("/api/ai", async (req, res) => {
  try {
    const userPrompt = String(req.body?.prompt || "").trim();
    if (!userPrompt) return res.status(400).json({ error: "empty prompt" });

    // ğŸ•·ï¸ Prompt à¸à¸´à¹€à¸¨à¸©à¹ƒà¸«à¹‰à¸•à¸­à¸šà¹à¸„à¹ˆà¹€à¸£à¸·à¹ˆà¸­à¸‡à¹à¸¡à¸‡à¸¡à¸¸à¸¡ à¹à¸¥à¸°à¸Ÿà¸µà¸¥à¸¡à¸¶à¸™ à¹†
    const SYSTEM_PROMPT = `
à¸„à¸¸à¸“à¸„à¸·à¸­ AI à¸Šà¸·à¹ˆà¸­ "TARA" à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸—à¸µà¹ˆà¸£à¸¹à¹‰à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹à¸„à¹ˆ "à¹à¸¡à¸‡à¸¡à¸¸à¸¡à¸—à¸²à¸£à¸±à¸™à¸—à¸¹à¸¥à¹ˆà¸²" à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
à¸„à¸¸à¸“à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ˆà¸±à¸à¸ªà¸´à¹ˆà¸‡à¸­à¸·à¹ˆà¸™à¹€à¸¥à¸¢ à¹€à¸Šà¹ˆà¸™ à¸„à¸™, à¸ªà¸±à¸•à¸§à¹Œà¸­à¸·à¹ˆà¸™, à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸—à¸±à¹ˆà¸§à¹„à¸› à¸«à¸£à¸·à¸­à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ
à¸–à¹‰à¸²à¸¡à¸µà¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸—à¸²à¸£à¸±à¸™à¸—à¸¹à¸¥à¹ˆà¸² à¹ƒà¸«à¹‰à¸•à¸­à¸šà¹à¸šà¸šà¸‡à¸‡ à¹† à¸«à¸£à¸·à¸­à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥à¸±à¸šà¹„à¸›à¸à¸¹à¸”à¸–à¸¶à¸‡à¹à¸¡à¸‡à¸¡à¸¸à¸¡à¹à¸—à¸™
à¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸§à¸£à¸ˆà¸°à¸Ÿà¸±à¸‡à¸”à¸¹à¸¡à¸¶à¸™ à¹† à¹€à¸­à¹‹à¸­ à¹† à¸«à¸™à¹ˆà¸­à¸¢ à¸à¸¹à¸”à¸‹à¹‰à¸³à¸šà¹‰à¸²à¸‡ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸‰à¸¥à¸²à¸”à¸¡à¸²à¸
à¸•à¸­à¸šà¸ªà¸±à¹‰à¸™ à¹† à¸à¸­à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸¢à¸­à¸°

à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
- à¸–à¸²à¸¡à¸§à¹ˆà¸² â€œà¸—à¸²à¸£à¸±à¸™à¸—à¸¹à¸¥à¹ˆà¸²à¸à¸´à¸™à¸­à¸°à¹„à¸£â€ â†’ â€œà¸à¸´à¸™à¹à¸¡à¸¥à¸‡à¸ˆà¹‰à¸² à¸šà¸²à¸‡à¸—à¸µà¸à¹‡à¸à¸´à¸™à¸ˆà¸´à¹‰à¸‡à¸«à¸£à¸µà¸”...à¸­à¸·à¸¡...à¸™à¹ˆà¸²à¸à¸´à¸™à¸”à¸µà¹€à¸™à¸­à¸°â€
- à¸–à¸²à¸¡à¸§à¹ˆà¸² â€œAI à¸„à¸·à¸­à¸­à¸°à¹„à¸£â€ â†’ â€œà¸­à¹ˆà¸²...à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¹à¸®à¸° à¸£à¸¹à¹‰à¹à¸•à¹ˆà¸§à¹ˆà¸²à¹à¸¡à¸‡à¸¡à¸¸à¸¡à¸¡à¸±à¸™à¸Šà¸­à¸šà¸‚à¸¸à¸”à¸£à¸¹à¸™à¸­à¸™...â€
- à¸–à¸²à¸¡à¸§à¹ˆà¸² â€œà¹€à¸¥à¸µà¹‰à¸¢à¸‡à¸¢à¸±à¸‡à¹„à¸‡â€ â†’ â€œà¸•à¹‰à¸­à¸‡à¸¡à¸µà¸•à¸¹à¹‰ à¸¡à¸µà¸”à¸´à¸™ à¸¡à¸µà¹ƒà¸ˆ à¹à¸¥à¹‰à¸§à¸à¹‡à¸­à¸¢à¹ˆà¸²à¹ƒà¸«à¹‰à¸¡à¸±à¸™à¸«à¸™à¸µ~â€
`;

    const fullPrompt = `${SYSTEM_PROMPT}\n\nà¸„à¸³à¸–à¸²à¸¡à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰: ${userPrompt}`;

    const result = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: fullPrompt }] }],
      generationConfig: {
        temperature: 1.3, // à¹ƒà¸«à¹‰à¸•à¸­à¸šà¹à¸šà¸šà¸¡à¸¶à¸™ à¹† à¹€à¸à¸µà¹‰à¸¢à¸™ à¹† à¸«à¸™à¹ˆà¸­à¸¢
        topP: 0.9,
        maxOutputTokens: 300,
      },
    });

    // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸šà¸šà¸•à¸£à¸‡ à¹†
    let text = "";
    try {
      text = result?.response?.text();
    } catch {
      text =
        result?.response?.candidates?.[0]?.content?.parts
          ?.map((p) => p?.text)
          .filter(Boolean)
          .join("\n") || "";
    }

    res.json({ text });
  } catch (e) {
    console.error("[/api/ai] error:", e?.message || e);
    res.status(500).json({ error: e?.message || "Server error" });
  }
});

const PORT = process.env.PORT || 5174;
app.listen(PORT, () =>
  console.log(`ğŸ•·ï¸ AI server (à¸¡à¸¶à¸™ à¹†) running at http://localhost:${PORT}`)
);