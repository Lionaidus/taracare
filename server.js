// server.js
import express from "express";
import cors from "cors";
import "dotenv/config";
import { GoogleGenerativeAI } from "@google/generative-ai";

const app = express();

// --- CORS ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î origin ‡∏ú‡πà‡∏≤‡∏ô .env ---
app.use(
  cors({
    origin: process.env.CORS_ORIGIN || "*",
  })
);
app.use(express.json({ limit: "1mb" }));

app.get("/api/health", (_req, res) => res.json({ ok: true }));

// ---[0] ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤ .env ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ---
if (!process.env.GEMINI_API_KEY) {
  console.warn("[WARN] GEMINI_API_KEY is missing in environment variables.");
}

// ---[1] System Prompt: ‡∏ï‡∏£‡∏∂‡∏á‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï + ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ---
const SYSTEM_PROMPT =
  process.env.SYSTEM_PROMPT ||
  `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå TaraCare
- ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï: ‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤" ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏î‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏π‡πâ ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏£‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢ ‡∏Å‡∏≤‡∏£‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡∏Ø‡∏•‡∏Ø)
- ‡∏ñ‡πâ‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡∏∞‡∏ä‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤
- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö: ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏î‡πâ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (~80‚Äì160 ‡∏Ñ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠ bullet 5‚Äì8 ‡∏Ç‡πâ‡∏≠)
- ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£/‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£)
- ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏î‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢/‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå
`.trim();

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// ---[2] ‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏• + systemInstruction ---
const model = genAI.getGenerativeModel({
  model: process.env.GEMINI_MODEL || "gemini-2.5-flash",
  systemInstruction: SYSTEM_PROMPT,
  // ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏£‡πå‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ (‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
  responseMimeType: "text/markdown",
});

// ---[3] ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢ generationConfig ---
const generationConfig = {
  temperature: 0.3, // ‡∏•‡∏î‡∏ü‡∏∏‡πâ‡∏á ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
  topP: 0.9,
  maxOutputTokens: 320, // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 80‚Äì160 ‡∏Ñ‡∏≥
  candidateCount: 1,
};

// ---[4] Hard Guard: ‡∏ñ‡∏≤‡∏°‡∏ô‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏õ‡∏±‡∏î‡∏ï‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ---
const TARANTULA_KEYWORDS = [
  "‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤",
  "tarantula",
  "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°",
  "Brachypelma",
  "Grammostola",
  "Aphonopelma",
  "Poecilotheria",
  "Avicularia",
  "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô",
  "‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥",
  "substrate",
  "‡∏ã‡∏±‡∏ö‡∏™‡πÄ‡∏ï‡∏£‡∏ï",
  "‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
  "‡∏à‡∏¥‡πâ‡∏á‡∏´‡∏£‡∏µ‡∏î",
  "‡∏î‡∏π‡∏ö‡∏¥‡∏≠‡∏≤",
  "‡∏ï‡∏π‡πâ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á",
  "‡∏ü‡∏≠‡∏™‡∏ã‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•",
  "‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•",
  "‡πÄ‡∏ó‡∏≠‡πÄ‡∏£‡∏™‡πÄ‡∏ó‡∏£‡∏µ‡∏¢‡∏•",
  "‡∏•‡∏≠‡∏Å‡∏Ñ‡∏£‡∏≤‡∏ö",
  "molt",
];

function isOnTopic(q) {
  const s = String(q || "").toLowerCase();
  return TARANTULA_KEYWORDS.some((k) => s.includes(k.toLowerCase()));
}

// ---[5] ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô) ---
function clampWords(text, maxWords = 180) {
  const words = text.trim().split(/\s+/);
  if (words.length <= maxWords) return text.trim();
  return words.slice(0, maxWords).join(" ") + " ‚Ä¶";
}

// ---[6] Endpoint ‡∏´‡∏•‡∏±‡∏Å ---
app.post("/api/ai", async (req, res) => {
  try {
    const prompt = String(req.body?.prompt || "").trim();
    if (!prompt) return res.status(400).json({ error: "empty prompt" });

    // 6.1 Guard ‡∏ô‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
    if (!isOnTopic(prompt)) {
      return res.json({
        text:
          "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üòä " +
          "‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏ï‡∏π‡πâ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!",
      });
    }

    // 6.2 ‡∏´‡πà‡∏≠ prompt ‡πÉ‡∏´‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    const userMessage = `
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô):
${prompt}

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏î‡πâ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°
- ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏ô‡∏≠‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡∏∞‡∏ä‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤
- ‡∏¢‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 80‚Äì160 ‡∏Ñ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ bullet 5‚Äì8 ‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞)
- ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ (‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£/‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£)
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢/‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå
`.trim();

    const result = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: userMessage }] }],
      generationConfig,
      // safetySettings: [...] // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö threshold ‡πÄ‡∏â‡∏û‡∏≤‡∏∞
    });

    // 6.3 ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô SDK
    let text = "";
    try {
      text = result?.response?.text();
    } catch {
      text =
        result?.response?.candidates?.[0]?.content?.parts
          ?.map((p) => p?.text)
          .filter(Boolean)
          .join("\n") || "";
    }

    // 6.4 Soft limit ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß
    text = clampWords(text, 180);

    // 6.5 ‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏á
    if (!text) {
      text =
        "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏≤‡∏£‡∏±‡∏ô‡∏ó‡∏π‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö";
    }

    return res.json({ text });
  } catch (e) {
    console.error("[/api/ai] error:", e?.message || e);
    return res.status(500).json({ error: e?.message || "Server error" });
  }
});

// ---[7] Debug endpoint ‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ---
app.get("/api/debug", (_req, res) => {
  res.json({
    model: process.env.GEMINI_MODEL || "gemini-2.5-flash",
    hasSystemPrompt: Boolean(process.env.SYSTEM_PROMPT),
    corsOrigin: process.env.CORS_ORIGIN || "*",
    ts: new Date().toISOString(),
  });
});

const PORT = process.env.PORT || 5174;
app.listen(PORT, () =>
  console.log(`AI server running at http://localhost:${PORT}`)
);
